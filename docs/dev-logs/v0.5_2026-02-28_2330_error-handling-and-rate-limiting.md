# Dev Log: Error Handling, Rate Limiting, Report Restructure & Product Voice

**Version:** v0.5
**Date:** 2026-02-28

## What Happened in This Session

### Task 1: Error Tracing Strategy
**Question:** What's the best approach for error tracing pre-LinkedIn launch?
**Answer/Solution:** Identified three layers (code crashes, bad output, platform issues). Chose Supabase for error logging over Sentry or Python logging — leverages existing infra with session/run correlation.
**Decision:** Log errors to Supabase `error_logs` table. Layer 2 (bad output) deferred to v0.6.
**Files modified:** `tracking.py` (log_error, mark_run_failed), `supabase_schema.sql` (error_logs table), `streamlit_app.py` (try/except + friendly error UI)

### Task 2: Rate Limiting
**Question:** How to protect API budget without adding user friction?
**Answer/Solution:** Invisible per-session limit (3 analyses). Limit message includes LinkedIn link for lead generation. Zero onboarding friction.
**Decision:** Option 1 (per-session count via Supabase) — not access code gate.
**Files modified:** `tracking.py` (is_rate_limited, check_rate_limit), `streamlit_app.py` (rate check before pipeline)

### Task 3: Retry Logic
**Answer/Solution:** `_retry_api_call()` helper in `agent.py` — retries once with exponential backoff on transient errors (rate limits, timeouts, 500s, connection). Tavily `search_web()` also retries once.
**Files modified:** `agent.py`, `tools.py`

### Task 4: Report Restructure for Speed & Scannability
**Question:** Reports too long (300–800 lines, 2–5 min). Users won't wait or read that much.
**Answer/Solution:** Rewrote `ANALYSIS_PROMPT` — 5 tight sections (Gap Matrix, Regulatory Landscape, Gap Details, Next Steps, Bottom Line). Removed Agent Reasoning section. Reduced `max_tokens` 16000→8000, thinking budget 8000→4000. Target: 150–250 lines, under 2 min.
**Decision:** Scannable and concise over thorough — reversed the v0.3 decision for launch readiness.
**Files modified:** `prompts.py`, `agent.py`

### Task 5: Report Voice & Product Identity
**Question:** Reports make arrogant assumptions about user's product. Tone is accusatory and stressful.
**Answer/Solution:** Added VOICE & TONE section to prompt. Gentle advisor, not auditor. "Potential gaps" language aligned with product name. No assumptions about user's implementation. No fear-based language.
**Decision:** Product value prop articulated: "help you quickly see potential compliance gaps between your LLM/technology and your industry requirements."
**Files modified:** `prompts.py`, `.cursor/rules/agent-behavior.mdc` (Rule 4), `docs/PROJECT-SCHEMA.md`

### Task 6: Report Format Consistency
**Question:** Heading levels and sub-grouping styles vary between reports.
**Answer/Solution:** Added explicit markdown formatting examples to prompt (heading levels, bold patterns, bullet styles). Minor inconsistencies remain — logged as issue #32 (LOW).
**Files modified:** `prompts.py`

### Task 7: UI Polish
**Answer/Solution:** Timer hint "2–3 min" → "Usually about a minute". Removed local file path display from download area. Report filename format changed: date before slug, slug capped at 30 chars.
**Files modified:** `streamlit_app.py`, `agent.py`

### Task 8: Bug Fix
**Answer/Solution:** `load_dotenv()` missing in `streamlit_app.py` — local runs showed "Missing API keys" because env vars weren't loaded before the key check.
**Files modified:** `streamlit_app.py`

### Task 9: Agent Behavior Rule
**Answer/Solution:** Added Rule 4 (Report Voice & Product Identity) and Rule 5 (Token-Efficient Execution) to `agent-behavior.mdc`.
**Files modified:** `.cursor/rules/agent-behavior.mdc`

## Key Decisions Made

1. Error logging → Supabase (not Sentry) — existing infra, correlation keys
2. Rate limiting → invisible per-session (not access code) — zero friction for LinkedIn launch
3. Report strategy → scannable and concise — reversed v0.3 "thorough" decision
4. Report voice → gentle advisor, "potential gaps" — aligned with product name
5. Product value prop → "quickly see potential compliance gaps from LLM + industry cross-reference"
6. Token efficiency → agent prepares commands, user runs them
7. Report filename → date before slug for scannability

## Related Files

- Iteration doc: `docs/iterations/v0.5-error-handling-and-rate-limiting.md`
- Changelog: `CHANGELOG.md`
- Project Schema: `docs/PROJECT-SCHEMA.md` (updated with v0.5 decisions)
- Agent behavior rules: `.cursor/rules/agent-behavior.mdc` (Rules 4 & 5 added)
