# Dev Log: Supabase + Langfuse Tracking Setup

**Version:** v0.4
**Date:** 2026-02-27

## What Happened in This Session

### Task 1: Architecture Decision — Langfuse + Supabase
**Question:** User wants to track user behavior and AI agent reasoning. What's the best approach?
**Answer/Solution:** Discussed three options. User pushed back on assumptions about scope — they explicitly want Claude's internal reasoning process, not just standard observability. Settled on Langfuse (AI agent traces, extended thinking, tokens, cost) + Supabase (user sessions, events, report persistence).
**Decision:** Two-service architecture. Langfuse is instrumented at agent.py level (survives frontend pivots). Supabase tracks user-facing data (frontend-specific parts will be redone on pivot).
**Files modified:** None (architecture discussion)

### Task 2: Cursor Rule — No Assumptions
**Question:** User called out an assumption made in agent thinking. Wants a rule preventing this.
**Answer/Solution:** Created `.cursor/rules/no-assumptions.mdc` — always-apply rule requiring agent to confirm assumptions with user before acting.
**Decision:** Added as permanent workspace rule.
**Files modified:** `.cursor/rules/no-assumptions.mdc` (new)

### Task 3: Implementation
**Question:** Build the Langfuse + Supabase integration.
**Answer/Solution:** Implemented across 6 files:
- `agent.py` — Extended Thinking enabled, Langfuse @observe decorators, AnthropicInstrumentor, version bump to v0.4
- `prompts.py` — Structured reasoning sections added to both prompts
- `tracking.py` — New Supabase tracking module (uses postgrest, fail-safe)
- `supabase_schema.sql` — New schema reference file (4 tables)
- `streamlit_app.py` — User event tracking, secrets injection, handles new dict returns
- `requirements.txt` — Added postgrest, langfuse, opentelemetry-instrumentation-anthropic
**Decision:** Used `postgrest` instead of `supabase` SDK (full SDK requires C++ build tools for pyiceberg dependency). Used Langfuse 4.0.0b1 (pre-release) to fix Python 3.14 compatibility.
**Files modified:** agent.py, prompts.py, tracking.py (new), supabase_schema.sql (new), streamlit_app.py, requirements.txt

## Key Decisions Made
1. Langfuse for AI agent observability, Supabase for user/product data — separation of concerns
2. Extended Thinking with budget_tokens 3k (planning) and 8k (analysis) — captures Claude's raw reasoning
3. Structured reasoning prompts — Claude explains its decisions in user-readable format in every report
4. postgrest instead of supabase SDK — avoids C++ build dependency on Windows
5. langfuse 4.0.0b1 — fixes Python 3.14 Pydantic V1 incompatibility
6. CSV test-log kept as local backup alongside Supabase
7. All tracking is fail-safe — if Supabase/Langfuse are down, the app works normally

## Related Files
- Iteration doc: [docs/iterations/v0.4-supabase-langfuse-tracking.md](../iterations/v0.4-supabase-langfuse-tracking.md)
- Schema: [supabase_schema.sql](../../supabase_schema.sql)
- Tracking module: [tracking.py](../../tracking.py)
