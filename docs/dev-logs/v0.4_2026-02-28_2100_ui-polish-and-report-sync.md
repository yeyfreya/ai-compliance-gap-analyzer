# Dev Log: Architecture Fix, Correlation Key, UI Polish & Report Sync

**Version:** v0.4
**Date:** 2026-02-28

## What Happened in This Session

### Task 1: Git Branching Strategy Discussion
**Question:** Is main/dev branching a good approach for this project?
**Answer:** Yes — simplified Git Flow is the right level for a solo dev portfolio project. main = production (Streamlit Cloud deploys from here), dev = working branch.
**Decision:** Adopt main/dev branching after v0.4 wrap-up. Use PRs for merge documentation. Tag releases on main (`git tag v0.4`).

### Task 2: Remove Claude Name-Drops from Step Messages
**Question:** Pipeline step messages say "Claude is doing X" — this makes users think they could just use Claude directly. How to fix?
**Answer/Solution:** Changed step messages to agent-centric language:
- "asking Claude what to investigate" → "identifying key regulations to investigate"
- "Claude is writing the report" → "the agent is cross-referencing findings and writing your report"
**Decision:** Product identity matters — the agent should present as the product, not as a wrapper around Claude.
**Files modified:** `streamlit_app.py` (lines 239, 258-260)

### Task 3: Variable Time Expectation
**Question:** Some analyses take way longer than 3 minutes. Don't want to set false hope.
**Answer/Solution:** Updated timer subtitle from "This usually takes 2–3 minutes" to "Usually 2–3 min · may take longer for complex or region-specific cases". Kept it in the same line to avoid UI clutter.
**Files modified:** `streamlit_app.py` (line 221)

### Task 4: Report Sync from Supabase
**Question:** Cloud-generated reports only exist in Supabase, not in local reports/ folder. Need a complete local record.
**Answer/Solution:** Created `sync_reports.py` — CLI script that:
1. Connects to Supabase and fetches all reports with linked run metadata
2. Checks which aren't already in local `reports/` folder
3. Downloads missing reports with correct naming
4. Appends missing entries to `test-log.csv`
5. Idempotent — re-running skips already-synced files
**Decision:** Supabase is the right source (not Langfuse) because it stores the full report markdown and run metadata.
**Files modified:** `sync_reports.py` (new file)

### Task 5: Supabase Schema Review
**Question:** Having trouble reading/connecting records between tables. UTC time concern.
**Answer/Solution:**
- Explained table relationships (sessions → analysis_runs → reports, with user_events linking to both sessions and runs)
- Provided SQL join queries for cross-table reading
- Suggested creating a `session_overview` database view for easy browsing
- Noted that `session_id` in `analysis_runs` is nullable — can create orphan runs if Supabase is down (acceptable for fail-safety)
- UTC is correct practice — `timestamptz` stores UTC, can display in any timezone with `AT TIME ZONE`
**Decision:** No schema changes needed. Suggested creating a view for easier reading.

### Task 6: Timestamp Unification
**Question:** UTC timestamps from Supabase sync don't match local timestamps. Should they be unified?
**Answer/Solution:** Yes — synced timestamps were in ISO 8601 UTC (`2026-02-28T20:04:44+00:00`) while local ones used `YYYY-MM-DD HH:MM:SS` in local time. Added `_utc_to_local()` converter to `sync_reports.py`. Re-synced all reports with corrected timestamps.
**Decision:** All timestamps in local files (reports, test-log.csv) should be in local time with consistent format. UTC is correct for database storage.
**Files modified:** `sync_reports.py`

### Task 7: Cross-Service Correlation — Universal `run_id`
**Question:** How to match local reports with Supabase and Langfuse records for analysis?
**Root cause discovered:** The Streamlit app called `plan_searches()`, `conduct_research()`, and `analyze_compliance()` directly inline, creating three separate Langfuse traces instead of one grouped trace. This architectural gap made correlation impossible — there was no parent entity to attach a `run_id` to.
**Answer/Solution:**
- **Architecture fix:** Created `_run_pipeline()` function decorated with `@observe(name="compliance_pipeline")`. All three pipeline steps are now child spans under this parent trace. The parent trace is tagged with `run_id` and `session_id` via OTel span attributes.
- **Correlation key:** Supabase `run_id` is now embedded in: local report headers, test-log.csv (new column), Langfuse trace metadata, and synced reports. Any record can be traced to any other system via this single UUID.
**Decision:** Always fix the architectural root cause, not the symptom. The fragmented trace structure was the real blocker.
**Files modified:** `streamlit_app.py` (major refactor), `agent.py` (`save_report`, `append_test_log`), `sync_reports.py`

### Task 8: Agent Behavior Rules Consolidation
**Question:** Combine all agent behavior rules into one cursor rule + add rules for root cause surfacing and product marketing thinking.
**Answer/Solution:** Created `.cursor/rules/agent-behavior.mdc` consolidating: (1) no-assumptions / confirm before acting, (2) surface architectural root causes before patching symptoms, (3) product marketing thinking for user-facing content. Deleted standalone `no-assumptions.mdc`.
**Files modified:** `.cursor/rules/agent-behavior.mdc` (new), `.cursor/rules/no-assumptions.mdc` (deleted)

### Task 9: Code Audit — Cross-File Misalignment Fix
**Question:** Are there any misalignments between files after all the session 2 edits?
**Root cause found:** `streamlit_app.py` was passing `run_id` to `save_report()` and `append_test_log()`, but `agent.py` hadn't been updated — these functions lacked the `run_id` parameter entirely. Would have crashed at runtime.
**Answer/Solution:**
- Added `run_id: str | None = None` to `save_report()` and `append_test_log()` in `agent.py`
- Added `_TEST_LOG_FIELDS` canonical column order in both `agent.py` and `sync_reports.py`
- Added `_migrate_csv_header()` in both files for one-time CSV migration (adds `run_id` column)
**Files modified:** `agent.py`, `sync_reports.py`

### Task 10: Integration Test Suite
**Question:** Set up tests to verify parent trace fix and cross-service correlation.
**Answer/Solution:** Expanded `test_tracking.py` from a basic connection test to a 4-part test suite:
1. `test_supabase()` — Supabase CRUD + cross-table linkage (session → run → report → events)
2. `test_langfuse()` — Langfuse client init + basic tracing
3. `test_parent_trace()` — Parent trace architecture: nested `@observe()` spans with OTel metadata (`run_id`, `session_id`, `app_version`)
4. `test_local_report_correlation()` — `run_id` in local report header + test-log.csv
**Result:** All 4 tests passed.
**Files modified:** `test_tracking.py`

### Task 11: Known Non-Bug Rule
**Question:** Windows GBK emoji error keeps getting "fixed" by removing emoji — but it's a Cursor agent terminal bug, not a code bug.
**Answer/Solution:** Added a "Known Non-Bugs" section to `.cursor/rules/documentation-system.mdc` documenting the Windows GBK UnicodeEncodeError as a Cursor shell issue. Agents must not strip emoji from source code.
**Files modified:** `.cursor/rules/documentation-system.mdc`

### Task 12: Streamlit Cloud TypeError After Code Update
**Error:** `TypeError: save_report() got an unexpected keyword argument 'run_id'` at `streamlit_app.py:322` — occurred after analysis completed (~274s), when saving the report.
**Root cause:** Streamlit Cloud module caching. After a GitHub pull updates code, the new `streamlit_app.py` runs (calling `save_report(..., run_id=run_id)`) but Python’s import cache keeps the old `agent.py` in memory, which does not accept `run_id`.
**Immediate fix:** Reboot the app on Streamlit Cloud (Manage app → ⋮ menu → Reboot app) to clear the module cache. A page refresh is not enough.
**Gap identified:** No structured error logging — runtime failures (pipeline, save, Supabase persist) are not logged to Supabase or Langfuse. Only raw tracebacks appear in Streamlit Cloud logs.
**Follow-up (deferred):** Add try/except around post-pipeline operations, log errors to Supabase via `complete_run(..., status="error", error_message=...)`, and surface user-friendly error messages in the UI.

## Key Decisions Made
1. Adopt main/dev branching after v0.4 wrap-up
2. Always use PRs for merge documentation + tag releases on main
3. Agent step messages should use product identity language, not name underlying models
4. Supabase is the canonical source for cloud-generated reports; `sync_reports.py` bridges cloud→local
5. UTC storage is correct; no timezone changes needed in schema
6. All local file timestamps should be unified in local time format
7. `run_id` is the universal correlation key across local docs, Supabase, and Langfuse
8. Always fix architectural root causes before patching symptoms (new agent rule)
9. Windows GBK emoji error is a Cursor terminal bug — never strip emoji from code
10. After GitHub pulls on Streamlit Cloud, reboot the app to avoid module cache mismatch; structured error logging is a deferred improvement

## Related Files
- Iteration doc: [docs/iterations/v0.4-supabase-langfuse-tracking.md](../iterations/v0.4-supabase-langfuse-tracking.md)
- Modified: `streamlit_app.py` (parent trace refactor), `agent.py` (run_id in reports/CSV), `sync_reports.py` (timestamps + run_id), `test_tracking.py` (4-part test suite)
- New: `.cursor/rules/agent-behavior.mdc`
- Deleted: `.cursor/rules/no-assumptions.mdc`
- Updated: `CHANGELOG.md`, `README.md`, `docs/PROJECT-SCHEMA.md`, `.cursor/rules/documentation-system.mdc`
