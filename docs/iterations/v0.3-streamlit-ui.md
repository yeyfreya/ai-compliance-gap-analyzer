# v0.3 — Streamlit UI & Report Structure

**Date:** 2026-02-26
**Analyst:** Cursor AI Agent (Claude)
**Source chats:**
- Session 1: Streamlit UI, bug #17 investigation, analysis prompt, UX improvements

---

## Goal

Build a Streamlit web interface for live demo. Ship a working UI that lets users input their AI scenario and receive a compliance gap report — replacing the CLI-only workflow.

Secondary goals from this session:
- Investigate Windows GBK encoding error (issue #17 from v0.2) — turned out to be Cursor-only, not a code bug
- Add Risk Prioritization Matrix as mandatory first section of every report
- Improve waiting UX during long analysis runs

---

## Changes Made During This Version

### Streamlit web app (`streamlit_app.py`) — NEW FILE
- **What:** Full Streamlit UI for the compliance analysis pipeline.
- **Layout:** Sidebar with scenario picker (dropdown pre-fills from `TEST_SCENARIOS`) + custom input fields. Main area shows hero title, progress status during analysis, timing metrics, tabbed report/queries view, and download button.
- **Progress UX:** Three-phase `st.status()` with step counter in label ("step 1/3", "step 2/3", "step 3/3"). Live JavaScript elapsed timer runs in browser via `components.html()` iframe — keeps counting even while Python is blocked on API calls. Timer replaced with static "Report generated in X:XX" when analysis completes. Hint: "This usually takes 2–3 minutes."
- **Architecture decision:** Calls individual pipeline functions (`plan_searches`, `conduct_research`, `analyze_compliance`) instead of `run_analysis()` — enables per-step progress feedback in the UI. Still calls `save_report()` and `append_test_log()` after completion.
- **Session state:** Uses `st.session_state` to persist results across Streamlit reruns.
- **Download:** `st.download_button` for the generated markdown report.
- **Why:** CLI is fine for development but not for demos. Streamlit gives a professional-looking interface with zero frontend code.

### Streamlit theme (`.streamlit/config.toml`) — NEW FILE
- **What:** Dark theme config — primary blue (#4F8BF9), dark background (#0E1117), light text (#FAFAFA).
- **Why:** Consistent visual style for the demo. Dark theme is standard for developer/technical tools.

### Bug #17 investigated — Windows GBK encoding error — NOT A CODE BUG
- **Symptom:** `UnicodeEncodeError: 'gbk' codec can't encode character` on emoji `print()` calls when running `streamlit run` from Cursor's built-in shell.
- **Investigation:** The AI agent proposed a fix (`sys.stdout.reconfigure(encoding="utf-8")`), but the user tested running Streamlit from their own PowerShell terminal and **it worked fine** — no encoding error.
- **Root cause:** Cursor's shell runner uses a different encoding configuration than the user's own terminal. The emoji print statements work correctly in the user's actual environment.
- **Decision:** User pushed back — this is a Cursor IDE environment quirk, not a bug in the project code. No fix applied. The code is correct as-is.
- **Status:** Closed — not a code bug. Remains documented as issue #17 under "Cursor environment only" for reference.

### Analysis prompt rewrite (`prompts.py`)
- **What:** Rewrote `ANALYSIS_PROMPT` to enforce Risk Prioritization Matrix as mandatory first section, with flexible structure for the detailed analysis.
- **Matrix format locked:** `| Gap | Risk Level | Regulatory Impact | Implementation Difficulty | Priority |` with standardized risk levels (CRITICAL, HIGH, MEDIUM, LOW) and priority ordering.
- **Structure approach:** Mandatory matrix at top, then minimum required sections (regulations, risks, gaps, recommendations), but Claude is free to add additional sections (conclusion, cost estimates, vendor-specific guidance) where the scenario warrants it.
- **Why:** Issue #16 — report structure varied between runs. The matrix gives a consistent executive summary while allowing Claude flexibility on the detailed analysis sections.
- **Performance impact:** The structured prompt produces longer, more thorough reports (~750 lines vs ~290 lines with old prompt). Analysis time increased from ~66s to ~185s. Decision: keep the thorough output — report quality is more valuable than speed at this stage.

### Added `regtech` test scenario (`agent.py`)
- **What:** New entry in `TEST_SCENARIOS`: AI agent powered compliance gap analyzer / Anthropic Claude Sonnet 4.5 / RegTech AI compliance SaaS — serving early-stage AI startups.
- **Why:** The tool analyzing itself — useful for demo and testing. Also established that the project's own industry category is RegTech, not legal services.

### Version bump (`agent.py`)
- **What:** Default `version` parameter in `run_analysis()` changed from `"v0.2"` to `"v0.3"`.

---

## Test Results

### Test Run 1 — RegTech (pre-prompt-rewrite, via Streamlit)
- **Scenario:** Custom — AI agent powered compliance gap analyzer / Claude Sonnet 4.5 / Law (US based)
- **Report:** `reports/report_v0.3_ai-agent-powered-compliance-gap-analyzer_20260226_154121.md` (289 lines)
- **Timing:** 88.1s total (planning: 9.3s, research: 12.8s, analysis: 65.9s)
- **Outcome:** First Streamlit test run. Report generated successfully. Risk Prioritization Matrix appeared at bottom (not enforced yet). Industry was "Law" — later corrected to RegTech.

### Test Run 2 — RegTech (post-prompt-rewrite, via Streamlit)
- **Scenario:** Regtech — AI agent powered compliance gap analyzer / Anthropic Claude Sonnet 4.5 / RegTech AI compliance SaaS
- **Report:** `reports/report_v0.3_ai-agent-powered-compliance-gap-analyzer_20260226_161145.md` (753 lines)
- **Timing:** 207.3s total (planning: 10.7s, research: 11.7s, analysis: 184.9s)
- **Outcome:** Risk Prioritization Matrix now appears first. Much longer/more detailed report. Analysis time ~3x longer due to increased output.

### Test Run 3 — Documentation tool (via Streamlit)
- **Report:** `reports/report_v0.3_ai-documentation-tool_20260226_162756.md` (789 lines)
- **Timing:** 195.4s total (planning: 9.0s, research: 14.2s, analysis: 172.1s)
- **Outcome:** Consistent with Run 2 — long report, ~3 min analysis.

### Test Run 4 — HR (via Streamlit)
- **Report:** `reports/report_v0.3_ai-powered-resume-screening-tool_20260226_163519.md`
- **Timing:** 69.9s total (planning: 9.7s, research: 11.7s, analysis: 48.4s)
- **Outcome:** Shorter report — analysis time varies by regulatory complexity (consistent with v0.2 findings).

### Observations
- **Streamlit UI works end-to-end** — scenario picker, custom input, progress tracking, report display, download all functional.
- **Analysis time increased** with the new structured prompt (48s–185s range vs 58s–103s in v0.2) due to longer output.
- **Timer UX works** — JS clock counts up during analysis, stops and shows final time when done.
- **Timer font color fixed** — originally black-on-black in dark theme, corrected to #FAFAFA.

---

## Remaining Issues for v0.4

### From v0.2 (still deferred)
| # | Issue | Source |
|---|---|---|
| 9 | System prompt misleading about tool access | Code analysis |
| 7 | Pipeline → agent loop (add research adequacy check) | Code analysis |
| 11 | `requirements.txt` has no version pins | Code analysis |
| 5 | Retry logic for API calls | Code analysis |
| 8 | Multi-turn Claude context (stateless calls) | Code analysis |
| 13 | Pre-process research text before sending to Claude | Code analysis |
| 14 | Include raw research sources in saved report | Code analysis |

### Resolved from v0.2
| # | Issue | Status |
|---|---|---|
| 16 | Analysis prompt doesn't enforce consistent report structure | Partially resolved — Risk Prioritization Matrix mandatory, rest flexible |
| 10 | Analysis prompt could request severity ratings, compliance scores | Partially resolved — matrix includes risk levels |
| 17 | Windows GBK encoding error on emoji output | Closed — not a code bug; only occurs in Cursor's shell runner, works fine in user's own terminal |
| 12 | Remove unused `streamlit` from requirements | Moot — Streamlit app now exists |

### New observations from v0.3
| # | Issue | Source |
|---|---|---|
| 18 | Analysis time increased to 2-3 min with structured prompt — acceptable for now but worth optimizing | Test runs |
| 19 | Report structure review completed — documented best structure for future prompt refinement | Analysis of all 6 reports |

---

## Version Log
- **2026-02-26** — v0.3 started, version bumped in `agent.py`
- **2026-02-26** — Created `streamlit_app.py` with full demo UI
- **2026-02-26** — Created `.streamlit/config.toml` dark theme
- **2026-02-26** — Bug #17 investigated: Windows GBK encoding error — user confirmed it only occurs in Cursor's shell, not in their own terminal. Closed as not a code bug. No fix applied.
- **2026-02-26** — Rewrote `ANALYSIS_PROMPT` in `prompts.py` — mandatory Risk Prioritization Matrix, flexible detail sections
- **2026-02-26** — Added `regtech` test scenario to `agent.py`
- **2026-02-26** — Test runs via Streamlit: regtech (x2), documentation, HR — all passed
- **2026-02-26** — Timer UX: added live JS elapsed clock, step progress labels, longest-step hint
- **2026-02-26** — Fixed timer font color (black → #FAFAFA for dark theme)
- **2026-02-26** — Timer now stops on completion, replaced with static "Report generated in X:XX"
- **2026-02-26** — Reverted conciseness constraint on analysis prompt — thorough reports preferred over speed
- **2026-02-26** — Updated timer hint from "2 minutes" to "2–3 minutes" to match actual times
