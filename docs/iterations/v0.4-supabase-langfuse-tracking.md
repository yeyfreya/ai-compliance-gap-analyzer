# v0.4 — Supabase + Langfuse Tracking

**Date:** 2026-02-27
**Analyst:** Cursor AI Agent (Claude)
**Source chats:**
- Session 1: Supabase + Langfuse architecture, extended thinking, structured reasoning, implementation

---

## Goal

Set up comprehensive observability for both user behavior and AI agent reasoning:
- **Langfuse** — AI agent observability: traces every Claude call with extended thinking, token usage, cost, latency. Instrumented at the `agent.py` level so it survives any frontend change.
- **Supabase** — User/product data: sessions, analysis runs, user events (clicks, downloads), and full report persistence. Solves issue #20 (ephemeral cloud reports).

Design principle: the observability layer must be sustainable beyond Streamlit — when the product pivots to an independent web app or OpenClaw plugin, Langfuse stays as-is and only the Supabase user-event tracking needs frontend-specific updates.

---

## Changes Made During This Version

### Extended Thinking enabled (`agent.py`)
- **What:** `plan_searches()` and `analyze_compliance()` now use Claude's Extended Thinking feature. The `thinking` parameter is enabled with budget_tokens of 3,000 (planning) and 8,000 (analysis). `max_tokens` increased to 5,000 and 16,000 respectively.
- **Return type change:** Both functions now return dicts instead of plain strings/lists. Dicts include `thinking` (Claude's internal chain-of-thought), `tokens_in`, `tokens_out`, plus the original output (`queries` or `analysis`).
- **Why:** The user explicitly wants to log Claude's internal reasoning process — not just inputs/outputs but the actual thinking behind each decision.

### Langfuse instrumentation (`agent.py`)
- **What:** Added `@observe()` decorators on `plan_searches()`, `conduct_research()`, `analyze_compliance()`, and `run_analysis()`. Added `AnthropicInstrumentor().instrument()` for automatic Claude API call tracing.
- **What it captures:** Nested traces per pipeline run, Claude API calls with model/tokens/cost, extended thinking blocks, function inputs/outputs, timing.
- **Why:** Purpose-built LLM observability tool — gives a dashboard, cost tracking, and trace visualization out of the box. Frontend-agnostic (decorators are on agent.py).

### Structured reasoning prompts (`prompts.py`)
- **What:** Updated `SEARCH_PLANNING_PROMPT` to ask Claude for a "Reasoning" section explaining why it chose each query, what it expects to find, and what it excluded. Updated `ANALYSIS_PROMPT` to add an "Agent Reasoning" section at the end of every report explaining prioritization decisions, influential findings, research gaps, and assumptions.
- **Why:** Extended thinking captures raw chain-of-thought; structured reasoning captures guided, user-readable explanations. Both are logged.

### Supabase tracking module (`tracking.py`) — NEW FILE
- **What:** New module with fail-safe Supabase integration using `postgrest` (lightweight PostgREST client instead of the full `supabase` SDK which has heavy C dependencies).
- **Functions:** `init_session()`, `start_run()`, `complete_run()`, `log_user_event()`, `save_report_to_db()`
- **Fail-safe:** All functions wrapped with `@_safe` decorator — Supabase errors are printed but never crash the app. If Supabase credentials are missing, tracking is silently disabled.
- **Why:** Track user behavior (what they input, download, click) and persist reports (solves ephemeral cloud storage issue).

### Supabase schema (`supabase_schema.sql`) — NEW FILE
- **What:** SQL schema for 4 tables: `sessions`, `analysis_runs`, `user_events`, `reports`. Includes indexes for common queries.
- **No agent_steps table:** AI agent step tracking is handled entirely by Langfuse. Supabase only stores user/product data.
- **Why:** Reference file for setting up the database. Run in Supabase SQL Editor.

### Streamlit app updates (`streamlit_app.py`)
- **What:** Added Supabase user event tracking at each interaction point (page load, scenario selection, analysis start, report download). Added secrets injection for Supabase and Langfuse env vars. Updated pipeline calls to handle new dict return types from `plan_searches()` and `analyze_compliance()`.
- **Version bumped to v0.4.**

### Version bump (`agent.py`)
- **What:** Default `version` parameter in `run_analysis()` changed from `"v0.3"` to `"v0.4"`.

### Dependencies (`requirements.txt`)
- **Added:** `postgrest>=2.28.0`, `langfuse>=4.0.0b1`, `opentelemetry-instrumentation-anthropic>=0.35.0`
- **Note:** Used `postgrest` instead of `supabase` SDK because the full SDK pulls in `pyiceberg` which requires C++ build tools on Windows. `postgrest` provides all the database operations we need.

---

## Architecture

```
User (Streamlit) → streamlit_app.py → agent.py → Claude API
                        │                  │
                        │                  └──→ Langfuse (traces, thinking, tokens, cost)
                        │
                        └──→ Supabase (sessions, runs, events, reports)
```

**What lives where:**
- Langfuse: Claude API calls, extended thinking, token usage, cost, per-step timing, function I/O
- Supabase: User sessions, analysis run metadata, UI interaction events, full report content
- CSV (kept as local backup): Same performance data as before, append-only

---

## Test Results

(To be filled after first test run)

---

## Remaining Issues for v0.5

### From v0.2/v0.3 (still deferred)
| # | Issue | Source |
|---|---|---|
| 9 | System prompt misleading about tool access | Code analysis |
| 7 | Pipeline → agent loop (add research adequacy check) | Code analysis |
| 5 | Retry logic for API calls | Code analysis |
| 8 | Multi-turn Claude context (stateless calls) | Code analysis |
| 13 | Pre-process research text before sending to Claude | Code analysis |
| 14 | Include raw research sources in saved report | Code analysis |
| 22 | API cost exposure — public demo has no rate limiting | Cloud deployment |

### New from v0.4
| # | Issue | Source |
|---|---|---|
| 23 | Langfuse Pydantic V1 warning on Python 3.14 — works but logs a warning | Dependency install |
| 24 | Supabase RLS disabled — fine for portfolio project, needs RLS if product goes live | Architecture decision |
| 25 | Extended thinking increases API cost — monitor token usage via Langfuse | Architecture decision |
| 26 | Streamlit Cloud deployment needs updated secrets (Supabase + Langfuse keys) | Deployment |

---

## Version Log
- **2026-02-27** — v0.4 started, version bumped in `agent.py` and `streamlit_app.py`
- **2026-02-27** — Created `supabase_schema.sql` with 4 tables
- **2026-02-27** — Enabled Extended Thinking on `plan_searches()` and `analyze_compliance()`
- **2026-02-27** — Added Langfuse `@observe()` decorators and `AnthropicInstrumentor`
- **2026-02-27** — Updated prompts.py with structured reasoning sections
- **2026-02-27** — Created `tracking.py` with fail-safe Supabase tracking functions
- **2026-02-27** — Instrumented `streamlit_app.py` with user event tracking
- **2026-02-27** — Added `postgrest`, `langfuse`, `opentelemetry-instrumentation-anthropic` to requirements
- **2026-02-27** — Resolved Langfuse Python 3.14 compatibility by upgrading to v4.0.0b1
- **2026-02-27** — No-assumptions rule added to `.cursor/rules/`
